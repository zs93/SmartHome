###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         18/Jan/2015  15:52:25 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  F:\zigbee project\terminal\Projects\zstack\Samples #
#                          \SampleApp\Source\SampleApp.c                      #
#    Command line       =  -f "F:\zigbee project\terminal\Projects\zstack\Sam #
#                          ples\SampleApp\CC2530DB\..\..\..\Tools\CC2530DB\f8 #
#                          wEndev.cfg" (-DCPU32MHZ -DROOT=__near_func         #
#                          -DMAC_CFG_TX_DATA_MAX=3 -DMAC_CFG_TX_MAX=6         #
#                          -DMAC_CFG_RX_MAX=3) -f "F:\zigbee                  #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg"   #
#                          (-DZIGBEEPRO -DSECURE=0 -DZG_SECURE_DYNAMIC=0      #
#                          -DREFLECTOR -DDEFAULT_CHANLIST=0x00000800          #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF0                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "F:\zigbee                  #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \Source\SampleApp.c" -D NWK_AUTO_POLL -D ZTOOL_P1  #
#                          -D xMT_TASK -D xMT_SYS_FUNC -D xMT_ZDO_FUNC -D     #
#                          xLCD_SUPPORTED=DEBUG -D LIVING_ROOM -D             #
#                          DEBUG_STAGE -D xDEV_CORE -D DEV_LIGHT -lC          #
#                          "F:\zigbee project\terminal\Projects\zstack\Sample #
#                          s\SampleApp\CC2530DB\EndDeviceEB\List\" -lA        #
#                          "F:\zigbee project\terminal\Projects\zstack\Sample #
#                          s\SampleApp\CC2530DB\EndDeviceEB\List\"            #
#                          --diag_suppress Pe001,Pa010 -o "F:\zigbee          #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\EndDeviceEB\Obj\" -e --no_code_motion    #
#                          --debug --core=plain --dptr=16,1                   #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I "F:\zigbee project\terminal\Projects\zstack\Sam #
#                          ples\SampleApp\CC2530DB\" -I "F:\zigbee            #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\Source\" -I "F:\zigbee                #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\ZMain\TI2530DB\" -I "F:\zigbee  #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\hal\include\"  #
#                          -I "F:\zigbee project\terminal\Projects\zstack\Sam #
#                          ples\SampleApp\CC2530DB\..\..\..\..\..\Components\ #
#                          hal\target\CC2530EB\" -I "F:\zigbee                #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\mac\include\"  #
#                          -I "F:\zigbee project\terminal\Projects\zstack\Sam #
#                          ples\SampleApp\CC2530DB\..\..\..\..\..\Components\ #
#                          mac\high_level\" -I "F:\zigbee                     #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\mac\low_level\ #
#                          srf04\" -I "F:\zigbee project\terminal\Projects\zs #
#                          tack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Com #
#                          ponents\mac\low_level\srf04\single_chip\" -I       #
#                          "F:\zigbee project\terminal\Projects\zstack\Sample #
#                          s\SampleApp\CC2530DB\..\..\..\..\..\Components\mt\ #
#                          " -I "F:\zigbee project\terminal\Projects\zstack\S #
#                          amples\SampleApp\CC2530DB\..\..\..\..\..\Component #
#                          s\osal\include\" -I "F:\zigbee                     #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\services\saddr #
#                          \" -I "F:\zigbee project\terminal\Projects\zstack\ #
#                          Samples\SampleApp\CC2530DB\..\..\..\..\..\Componen #
#                          ts\services\sdata\" -I "F:\zigbee                  #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\stack\af\" -I  #
#                          "F:\zigbee project\terminal\Projects\zstack\Sample #
#                          s\SampleApp\CC2530DB\..\..\..\..\..\Components\sta #
#                          ck\nwk\" -I "F:\zigbee project\terminal\Projects\z #
#                          stack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Co #
#                          mponents\stack\sapi\" -I "F:\zigbee                #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\stack\sec\"    #
#                          -I "F:\zigbee project\terminal\Projects\zstack\Sam #
#                          ples\SampleApp\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\sys\" -I "F:\zigbee                          #
#                          project\terminal\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\stack\zdo\"    #
#                          -I "F:\zigbee project\terminal\Projects\zstack\Sam #
#                          ples\SampleApp\CC2530DB\..\..\..\..\..\Components\ #
#                          zmac\" -I "F:\zigbee project\terminal\Projects\zst #
#                          ack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Comp #
#                          onents\zmac\f8w\" -Ohz --require_prototypes        #
#    List file          =  F:\zigbee project\terminal\Projects\zstack\Samples #
#                          \SampleApp\CC2530DB\EndDeviceEB\List\SampleApp.lst #
#    Object file        =  F:\zigbee project\terminal\Projects\zstack\Samples #
#                          \SampleApp\CC2530DB\EndDeviceEB\Obj\SampleApp.r51  #
#                                                                             #
#                                                                             #
###############################################################################

F:\zigbee project\terminal\Projects\zstack\Samples\SampleApp\Source\SampleApp.c
      1          /**************************************************************************************************
      2            Filename:       SampleApp.c
      3            Revised:        $Date: 2009-03-18 15:56:27 -0700 (Wed, 18 Mar 2009) $
      4            Revision:       $Revision: 19453 $
      5          
      6            Description:    Sample Application (no Profile).
      7          
      8          
      9            Copyright 2007 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41            This application isn't intended to do anything useful, it is
     42            intended to be a simple example of an application's structure.
     43          
     44            This application sends it's messages either as broadcast or
     45            broadcast filtered group messages.  The other (more normal)
     46            message addressing is unicast.  Most of the other sample
     47            applications are written to support the unicast message model.
     48          
     49            Key control:
     50              SW1:  Sends a flash command to all devices in Group 1.
     51              SW2:  Adds/Removes (toggles) this device in and out
     52                    of Group 1.  This will enable and disable the
     53                    reception of the flash command.
     54          *********************************************************************/
     55          
     56          /*********************************************************************
     57           * INCLUDES
     58           */
     59          #include "OSAL.h"
     60          #include "ZGlobals.h"
     61          #include "AF.h"
     62          #include "aps_groups.h"
     63          #include "ZDApp.h"
     64          
     65          #include "SampleApp.h"
     66          #include "SampleAppHw.h"
     67          
     68          #include "OnBoard.h"

   \                                 In  segment SFR_AN, at 0x80
   \   union <unnamed> volatile __sfr _A_P0
   \                     _A_P0:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xf3
   \   unsigned char volatile __sfr P0SEL
   \                     P0SEL:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xfd
   \   unsigned char volatile __sfr P0DIR
   \                     P0DIR:
   \   000000                DS 1
     69          
     70          /* HAL */
     71          #include "hal_lcd.h"
     72          #include "hal_led.h"
     73          #include "hal_key.h"
     74          #include "mt_uart.h"//串口头文件
     75          //#include "MT_APP.H"
     76          #include "MT.h"//CMD_SERIAL_MSG任务ID在这里定义的
     77          #include <ioCC2530.h>
     78          #include <stdio.h>
     79          /************编译终端的时候需要将注释去掉**********/
     80          //#define DEV_COOR
     81          //#define DEBUG_STAGE
     82          /*****************************/
     83          /*
     84          #ifndef DEV_COOR
     85          #include "ds18b02.h"
     86          #endif
     87          */
     88          /**********************定义命令******************************/
     89          #ifndef CMD_H
     90          #define CMD_H
     91          
     92          /***定义命令的类型CmdType****/
     93          #define CMD_TYPE_CLOSELINK             0x00         /*断开连接*/
     94          #define CMD_TYPE_QUERYREQUEST          0x01         /*查询请求*/
     95          #define CMD_TYPE_QUERYRESPONSE         0x02         /*查询应答*/
     96          #define CMD_TYPE_CONTROLREQUEST        0x03         /*控制请求*/
     97          #define CMD_TYPE_CONTROLRESPONSE       0x04         /*控制应带*/
     98          /***cmd命令操作类型CmdCtrlType*/
     99          #define CMD_CONTROL_OPEN               0x00     // 打开 
    100          #define CMD_CONTROL_CLOSE              0x01     // 关闭
    101          #define CMD_CONTROL_WRITE              0x02     // 写 
    102          #define CMD_CONTROL_READ               0x03     // 读 
    103          #define CMD_CONTROL_START              0x04     // 开始 
    104          #define CMD_CONTROL_STOP               0x05     // 结束
    105          /*
    106          CmdCtrlValue     0x00 - 0xff
    107          */
    108          /***定义房间ID CmdRoomId***/
    109          #define CMD_ROOM_LIVINGROOM             0x00       //客厅
    110          #define CMD_ROOM_BEDROOM                0x01       //卧室
    111          #define CMD_ROOM_KITCHEN                0x02       //厨房
    112          /**cmd设备类型定义CmdDevType*/
    113          #define CMD_DEV_LED                0x00     // 灯
    114          #define CMD_DEV_CURTAIN            0x01     //窗帘
    115          /**命令的类型**/
    116          #define  CmdFlag         0                             /*帧头*/                        //0x7f
    117          #define  CmdType         1                             /* 命令类型 */
    118          #define  CmdCtrlType     2                             /* 命令控制的类型 */
    119          #define  CmdCtrlValue    3                             /* 命令值 */
    120          #define  CmdRoomId       4                             /* 房间号 */
    121          #define  CmdDevType      5                             /* 设备类型 */
    122          #define  CmdDevId        6                             /* 设备号 */
    123          /**
    124          CmdDevId 0x00 - 0xff
    125          
    126          定义的数目模型为 7f 0X 0X 0X 0X 0X 0X
    127          **/
    128          #define  CMD_LEN         7                 //一共是7个16位进制             
    129          #endif
    130          /*****************************以上为CMD******************************************/
    131          /*********自带led定义**********/
    132          #define LED1    HAL_LED_1  //自带的LED
    133          #define LED2    HAL_LED_2
    134          #define LED3    HAL_LED_3
    135          #define LED_ON  HAL_LED_MODE_ON
    136          #define LED_OFF HAL_LED_MODE_OFF
    137          /*********************各设备功能模块定义************************
    138          第一步：在这里添加外设的信息并设置相应的动作*/
    139          /*****************************************************************
    140              功能实现：DEV_LIGHT     灯      P0.4   输出
    141                        DEV_CURTAIN   窗帘    P0.0   输出
    142          ***************************************************************/
    143          //灯 P0.4 输出
    144          #ifdef  DEV_LIGHT
    145            #define DEV_LIGHT1_OPEN()        do{P0_4 = 1;}while(0);
    146            #define DEV_LIGHT1_CLOSE()       do{P0_4 = 0;}while(0);
    147            #define DEV_LIGHT1_BIT           (P0_4)
    148          #endif
    149          //窗帘 P0.0 输出
    150          #ifdef  DEV_CURTAIN
    151            #define DEV_CURTAIN_OPEN()       do{P0_0 = 1;}while(0);
    152            #define DEV_CURTAIN_CLOSE()      do{P0_0 = 0;}while(0);
    153            #define DEV_CURTAIN_BIT          (P0_0)
    154          #endif
    155          /*****************功能模块定义结束**************************/
    156          
    157          /***定义特有的房间号**/
    158          /********************************************
    159          LIVING_ROOM     客厅
    160          *******************************************/
    161          #ifndef DEV_COOR
    162              // #error  outdev_coor
    163               #ifdef  LIVING_ROOM
    164               #define ROOM_NUM   CMD_ROOM_LIVINGROOM //把房间号定义为客厅
    165               #endif
    166               #ifdef BED_ROOM
    167                 #define ROOM_NUM CMD_ROOM_BEDROOM
    168               #endif 
    169               #ifdef KITCHEN_ROOM
    170                 #define ROOM_NUM CMD_ROOM_KITCHEN
    171               #endif
    172               #define DEV_NUM 1
    173          #endif
    174          /***********************************************************/
    175          /******************定义房间数量与设备的孰料***************/
    176          #ifdef DEV_COOR
    177          
    178            //#error  indev_coor
    179          
    180            #define ROOM_COUNT 3
    181            #define DEV_COUNT 1
    182          #endif
    183          /********************************************************/
    184          
    185          //定义标志东西
    186          #define FRAME_FLAG  (0x7f)   //数据框架判断
    187          #define ERROR_FLAG  (0x6f)   
    188          /*********************************************************************
    189           * MACROS
    190           */
    191          
    192          /*********************************************************************
    193           * CONSTANTS
    194           */
    195          
    196          /*********************************************************************
    197           * TYPEDEFS
    198           */
    199          
    200          /*********************************************************************
    201           * GLOBAL VARIABLES
    202           */
    203          
    204          // This list should be filled with Application specific Cluster IDs.

   \                                 In  segment XDATA_ROM_C, align 1
    205          const cId_t SampleApp_ClusterList[SAMPLEAPP_MAX_CLUSTERS] =
   \                     SampleApp_ClusterList:
   \   000000   0100         DW 1
   \   000002   0200         DW 2
    206          {
    207            SAMPLEAPP_PERIODIC_CLUSTERID,
    208            SAMPLEAPP_FLASH_CLUSTERID
    209          };
    210          

   \                                 In  segment XDATA_ROM_C, align 1
    211          const SimpleDescriptionFormat_t SampleApp_SimpleDesc =
   \                     SampleApp_SimpleDesc:
   \   000000   14           DB 20
   \   000001   080F         DW 3848
   \   000003   0100         DW 1
   \   000005   00           DB 0
   \   000006   02           DB 2
   \   000007   ....         DW SampleApp_ClusterList
   \   000009   02           DB 2
   \   00000A   ....         DW SampleApp_ClusterList
    212          {
    213            SAMPLEAPP_ENDPOINT,              //  int Endpoint;
    214            SAMPLEAPP_PROFID,                //  uint16 AppProfId[2];
    215            SAMPLEAPP_DEVICEID,              //  uint16 AppDeviceId[2];
    216            SAMPLEAPP_DEVICE_VERSION,        //  int   AppDevVer:4;
    217            SAMPLEAPP_FLAGS,                 //  int   AppFlags:4;
    218            SAMPLEAPP_MAX_CLUSTERS,          //  uint8  AppNumInClusters;
    219            (cId_t *)SampleApp_ClusterList,  //  uint8 *pAppInClusterList;
    220            SAMPLEAPP_MAX_CLUSTERS,          //  uint8  AppNumInClusters;
    221            (cId_t *)SampleApp_ClusterList   //  uint8 *pAppInClusterList;
    222          };
    223          
    224          // This is the Endpoint/Interface description.  It is defined here, but
    225          // filled-in in SampleApp_Init().  Another way to go would be to fill
    226          // in the structure here and make it a "const" (in code space).  The
    227          // way it's defined in this sample app it is define in RAM.
    228          
    229          
    230          
    231          
    232          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    233          endPointDesc_t SampleApp_epDesc;
   \                     SampleApp_epDesc:
   \   000000                DS 6
   \   000006                REQUIRE __INIT_XDATA_Z
    234          //int DoorBellPressed = 0;//门铃
    235          
    236          
    237          
    238          /*********************************************************************
    239           * EXTERNAL VARIABLES
    240           */
    241          
    242          /*********************************************************************
    243           * EXTERNAL FUNCTIONS
    244           */
    245          
    246          /*********************************************************************
    247           * LOCAL VARIABLES
    248           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    249          uint8 SampleApp_TaskID;   // Task ID for internal task/event processing
   \                     SampleApp_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    250                                    // This variable will be received when
    251                                    // SampleApp_Init() is called.

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    252          devStates_t SampleApp_NwkState;
   \                     SampleApp_NwkState:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    253          #ifdef DEBUG_STAGE          //debug模式提供ASCII编码

   \                                 In  segment XDATA_I, align 1, keep-with-next
    254                 uint8 asc_16[16] = {'0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'};
   \                     asc_16:
   \   000000                DS 16
   \   000010                REQUIRE `?<Initializer for asc_16>`
   \   000010                REQUIRE __INIT_XDATA_I
    255          #endif      

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    256          uint8 SampleApp_TransID;  // This is the unique message ID (counter)
   \                     SampleApp_TransID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    257          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    258          afAddrType_t SampleApp_Periodic_DstAddr;
   \                     SampleApp_Periodic_DstAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    259          afAddrType_t SampleApp_Flash_DstAddr;
   \                     SampleApp_Flash_DstAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z
    260          /**自己定义的点对点的传输**/
    261          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    262            afAddrType_t SampleApp_Point_to_Point_DstAddr;
   \                     SampleApp_Point_to_Point_DstAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z
    263          
    264          /**************/

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    265          aps_Group_t SampleApp_Group;
   \                     SampleApp_Group:
   \   000000                DS 18
   \   000012                REQUIRE __INIT_XDATA_Z
    266          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    267          uint8 SampleAppPeriodicCounter = 0;
   \                     SampleAppPeriodicCounter:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    268          uint8 SampleAppFlashCounter = 0;
   \                     SampleAppFlashCounter:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    269          /*******路由表单********/
    270          #ifdef DEV_COOR
    271            uint16 Routing_Table[ROOM_COUNT][DEV_COUNT]={0};
    272          #endif
    273          
    274          //unsigned char temp_bank = 0;
    275          /************/
    276          /*********************************************************************
    277           * LOCAL FUNCTIONS
    278           */
    279          void SampleApp_HandleKeys( uint8 shift, uint8 keys );
    280          void SampleApp_MessageMSGCB( afIncomingMSGPacket_t *pckt );
    281          void SampleApp_SendPeriodicMessage( void );
    282          void SampleApp_SendFlashMessage( uint16 flashTime );
    283          
    284          /***my funtions**/
    285          #ifdef DEV_COOR
    286            void SampleApp_SerialCMD(mtOSALSerialData_t *cmdMsg);//串口接受到数据处理函数的申明
    287          #endif
    288            //void P1_ISR(void);
    289          /*********************************************************************
    290           * NETWORK LAYER CALLBACKS
    291           */
    292          
    293          /*********************************************************************
    294           * PUBLIC FUNCTIONS
    295           */
    296          
    297          /*********************************************************************
    298           * @fn      SampleApp_Init
    299           *
    300           * @brief   Initialization function for the Generic App Task.
    301           *          This is called during initialization and should contain
    302           *          any application specific initialization (ie. hardware
    303           *          initialization/setup, table initialization, power up
    304           *          notificaiton ... ).
    305           *
    306           * @param   task_id - the ID assigned by OSAL.  This ID should be
    307           *                    used to send messages and set timers.
    308           *
    309           * @return  none
    310           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    311          void SampleApp_Init( uint8 task_id )
   \                     SampleApp_Init:
    312          {
   \   000000   74F5         MOV     A,#-0xb
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 11
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    313            SampleApp_TaskID = task_id; //任务ID
   \   000007   90....       MOV     DPTR,#SampleApp_TaskID
   \   00000A   F0           MOVX    @DPTR,A
    314            SampleApp_NwkState = DEV_INIT;//网络类型
   \   00000B   90....       MOV     DPTR,#SampleApp_NwkState
   \   00000E   7401         MOV     A,#0x1
   \   000010   F0           MOVX    @DPTR,A
    315            SampleApp_TransID = 0;// 设置发送数据的方式和目的地址,
   \   000011   90....       MOV     DPTR,#SampleApp_TransID
   \   000014   E4           CLR     A
   \   000015   F0           MOVX    @DPTR,A
    316            /*****串口初始化******/
    317            MT_UartInit ();
   \   000016                ; Setup parameters for call to function MT_UartInit
   \   000016   12....       LCALL   ??MT_UartInit?relay
    318            MT_UartRegisterTaskID(task_id);
   \   000019                ; Setup parameters for call to function MT_UartRegisterTaskID
   \   000019   EE           MOV     A,R6
   \   00001A   F9           MOV     R1,A
   \   00001B   12....       LCALL   ??MT_UartRegisterTaskID?relay
    319          
    320            #ifndef DEV_COOR
    321              #ifdef DEBUG_STAGE
    322                #ifdef LIVING_ROOM
    323                 HalUARTWrite(0,"livingroom\n",11);
   \   00001E                ; Setup parameters for call to function HalUARTWrite
   \   00001E   7C0B         MOV     R4,#0xb
   \   000020   7D00         MOV     R5,#0x0
   \   000022   7A..         MOV     R2,#`?<Constant "livingroom\\n">` & 0xff
   \   000024   7B..         MOV     R3,#(`?<Constant "livingroom\\n">` >> 8) & 0xff
   \   000026   7900         MOV     R1,#0x0
   \   000028   12....       LCALL   ??HalUARTWrite?relay
    324                #endif
    325                #ifdef BED_ROOM
    326                 HalUARTWrite(0,"bedroom\n",8);
    327                #endif
    328                #ifdef KIT_ROOM
    329                 HalUARTWrite(0,"kitroom\n",8);
    330                #endif
    331              #endif
    332            #endif
    333          
    334            /******************终端设备各模块io初始化*******************/
    335            /*
    336                 第二步：这里添加需要的设置的IO初始化
    337            ***********************************************************/
    338          #ifndef DEV_COOR
    339              //灯 P0.4 输出
    340             #ifdef  DEV_LIGHT
    341                 P0SEL &= 0xef;//灯1配置I/O口  P0_4
   \   00002B   53F3EF       ANL     0xf3,#0xef
    342                 P0DIR |= 0x10;//LIGHT1 输出
   \   00002E   43FD10       ORL     0xfd,#0x10
    343                 P0_4 = 0;
   \   000031   C284         CLR     0x80.4
    344             #endif
    345           //窗帘 P0.0 输出  
    346             #ifdef DEV_CURTAIN
    347                P0SEL &= 0xfe;
    348                P0DIR |= 0x1;  //输出  
    349                P0_0 = 0;
    350             #endif
    351          #endif
    352          /************IO初始化结束**********************/
    353                
    354            // Device hardware initialization can be added here or in main() (Zmain.c).
    355            // If the hardware is application specific - add it here.
    356            // If the hardware is other parts of the device add it in main().
    357          
    358           #if defined ( BUILD_ALL_DEVICES )
    359            // The "Demo" target is setup to have BUILD_ALL_DEVICES and HOLD_AUTO_START
    360            // We are looking at a jumper (defined in SampleAppHw.c) to be jumpered
    361            // together - if they are - we will start up a coordinator. Otherwise,
    362            // the device will start as a router.
    363            if ( readCoordinatorJumper() )
    364              zgDeviceLogicalType = ZG_DEVICETYPE_COORDINATOR;
    365            else
    366              zgDeviceLogicalType = ZG_DEVICETYPE_ROUTER;
    367          #endif // BUILD_ALL_DEVICES
    368          
    369          #if defined ( HOLD_AUTO_START )
    370            // HOLD_AUTO_START is a compile option that will surpress ZDApp
    371            //  from starting the device and wait for the application to
    372            //  start the device.
    373            ZDOInitDevice(0);
    374          #endif
    375          
    376            // Setup for the periodic message's destination address
    377            // Broadcast to everyone
    378            SampleApp_Periodic_DstAddr.addrMode = (afAddrMode_t)AddrBroadcast;
   \   000033   90....       MOV     DPTR,#SampleApp_Periodic_DstAddr + 8
   \   000036   740F         MOV     A,#0xf
   \   000038   F0           MOVX    @DPTR,A
    379            SampleApp_Periodic_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
   \   000039   A3           INC     DPTR
   \   00003A   7414         MOV     A,#0x14
   \   00003C   F0           MOVX    @DPTR,A
    380            SampleApp_Periodic_DstAddr.addr.shortAddr = 0xFFFF;
   \   00003D   90....       MOV     DPTR,#SampleApp_Periodic_DstAddr
   \   000040   74FF         MOV     A,#-0x1
   \   000042   F0           MOVX    @DPTR,A
   \   000043   A3           INC     DPTR
   \   000044   F0           MOVX    @DPTR,A
    381          
    382            // Setup for the flash command's destination address - Group 1
    383            SampleApp_Flash_DstAddr.addrMode = (afAddrMode_t)afAddrGroup;
   \   000045   90....       MOV     DPTR,#SampleApp_Flash_DstAddr + 8
   \   000048   7401         MOV     A,#0x1
   \   00004A   F0           MOVX    @DPTR,A
    384            SampleApp_Flash_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
   \   00004B   A3           INC     DPTR
   \   00004C   7414         MOV     A,#0x14
   \   00004E   F0           MOVX    @DPTR,A
    385            SampleApp_Flash_DstAddr.addr.shortAddr = SAMPLEAPP_FLASH_GROUP;
   \   00004F   90....       MOV     DPTR,#SampleApp_Flash_DstAddr
   \   000052   7401         MOV     A,#0x1
   \   000054   F0           MOVX    @DPTR,A
   \   000055   A3           INC     DPTR
   \   000056   E4           CLR     A
   \   000057   F0           MOVX    @DPTR,A
    386          /***设定点对点的地址方案****/
    387            SampleApp_Point_to_Point_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
   \   000058   90....       MOV     DPTR,#SampleApp_Point_to_Point_DstAddr + 8
   \   00005B   7402         MOV     A,#0x2
   \   00005D   F0           MOVX    @DPTR,A
    388            SampleApp_Point_to_Point_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
   \   00005E   A3           INC     DPTR
   \   00005F   7414         MOV     A,#0x14
   \   000061   F0           MOVX    @DPTR,A
    389            SampleApp_Point_to_Point_DstAddr.addr.shortAddr = 0xffff;//数据从终端发给协调者
   \   000062   90....       MOV     DPTR,#SampleApp_Point_to_Point_DstAddr
   \   000065   74FF         MOV     A,#-0x1
   \   000067   F0           MOVX    @DPTR,A
   \   000068   A3           INC     DPTR
   \   000069   F0           MOVX    @DPTR,A
    390          /********************************/
    391            // Fill out the endpoint description.
    392            SampleApp_epDesc.endPoint = SAMPLEAPP_ENDPOINT;
   \   00006A   90....       MOV     DPTR,#SampleApp_epDesc
   \   00006D   7414         MOV     A,#0x14
   \   00006F   F0           MOVX    @DPTR,A
    393            SampleApp_epDesc.task_id = &SampleApp_TaskID;
   \   000070   A3           INC     DPTR
   \   000071   74..         MOV     A,#SampleApp_TaskID & 0xff
   \   000073   F0           MOVX    @DPTR,A
   \   000074   A3           INC     DPTR
   \   000075   74..         MOV     A,#(SampleApp_TaskID >> 8) & 0xff
   \   000077   F0           MOVX    @DPTR,A
    394            SampleApp_epDesc.simpleDesc
    395                      = (SimpleDescriptionFormat_t *)&SampleApp_SimpleDesc;
   \   000078   A3           INC     DPTR
   \   000079   74..         MOV     A,#SampleApp_SimpleDesc & 0xff
   \   00007B   F0           MOVX    @DPTR,A
   \   00007C   A3           INC     DPTR
   \   00007D   74..         MOV     A,#(SampleApp_SimpleDesc >> 8) & 0xff
   \   00007F   F0           MOVX    @DPTR,A
    396            SampleApp_epDesc.latencyReq = noLatencyReqs;
   \   000080   A3           INC     DPTR
   \   000081   E4           CLR     A
   \   000082   F0           MOVX    @DPTR,A
    397          
    398            // Register the endpoint description with the AF
    399            afRegister( &SampleApp_epDesc );
   \   000083                ; Setup parameters for call to function afRegister
   \   000083   7A..         MOV     R2,#SampleApp_epDesc & 0xff
   \   000085   7B..         MOV     R3,#(SampleApp_epDesc >> 8) & 0xff
   \   000087   12....       LCALL   ??afRegister?relay
    400          
    401            // Register for all key events - This app will handle all key events
    402            RegisterForKeys( SampleApp_TaskID );
   \   00008A                ; Setup parameters for call to function RegisterForKeys
   \   00008A   90....       MOV     DPTR,#SampleApp_TaskID
   \   00008D   E0           MOVX    A,@DPTR
   \   00008E   F9           MOV     R1,A
   \   00008F   12....       LCALL   ??RegisterForKeys?relay
    403          
    404            // By default, all devices start out in Group 1
    405            SampleApp_Group.ID = 0x0001;
   \   000092   90....       MOV     DPTR,#SampleApp_Group
   \   000095   7401         MOV     A,#0x1
   \   000097   F0           MOVX    @DPTR,A
   \   000098   A3           INC     DPTR
   \   000099   E4           CLR     A
   \   00009A   F0           MOVX    @DPTR,A
    406            osal_memcpy( SampleApp_Group.name, "Group 1", 7  );
   \   00009B                ; Setup parameters for call to function osal_memcpy
   \   00009B   75....       MOV     ?V0 + 0,#`?<Constant "Group 1">` & 0xff
   \   00009E   75....       MOV     ?V0 + 1,#(`?<Constant "Group 1">` >> 8) & 0xff
   \   0000A1   F5..         MOV     ?V0 + 2,A
   \   0000A3   78..         MOV     R0,#?V0 + 0
   \   0000A5   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000A8   7C07         MOV     R4,#0x7
   \   0000AA   7D00         MOV     R5,#0x0
   \   0000AC   7A..         MOV     R2,#(SampleApp_Group + 2) & 0xff
   \   0000AE   7B..         MOV     R3,#((SampleApp_Group + 2) >> 8) & 0xff
   \   0000B0   12....       LCALL   ??osal_memcpy?relay
   \   0000B3   7403         MOV     A,#0x3
   \   0000B5   12....       LCALL   ?DEALLOC_XSTACK8
    407            aps_AddGroup( SAMPLEAPP_ENDPOINT, &SampleApp_Group );
   \   0000B8                ; Setup parameters for call to function aps_AddGroup
   \   0000B8   7A..         MOV     R2,#SampleApp_Group & 0xff
   \   0000BA   7B..         MOV     R3,#(SampleApp_Group >> 8) & 0xff
   \   0000BC   7914         MOV     R1,#0x14
   \   0000BE   12....       LCALL   ??aps_AddGroup?relay
    408          
    409          #if defined ( LCD_SUPPORTED )
    410            HalLcdWriteString( "SampleApp", HAL_LCD_LINE_1 );
    411          #endif
    412          }
   \   0000C1   7F03         MOV     R7,#0x3
   \   0000C3   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   0000C6                REQUIRE P0SEL
   \   0000C6                REQUIRE P0DIR
   \   0000C6                REQUIRE _A_P0
    413          
    414          /*********************************************************************
    415           * @fn      SampleApp_ProcessEvent 任务处理函数。任务处理函数是对任务发生后的事件进行处理
    416           *
    417           * @brief   Generic Application Task event processor.  This function
    418           *          is called to process all events for the task.  Events
    419           *          include timers, messages and any other user defined events.
    420           *
    421           * @param   task_id  - The OSAL assigned task ID.
    422           * @param   events - events to process.  This is a bit map and can
    423           *                   contain more than one event.
    424           *
    425           * @return  none
    426           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    427          uint16 SampleApp_ProcessEvent( uint8 task_id, uint16 events )//发送处理函数
   \                     SampleApp_ProcessEvent:
    428          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 4
   \   000005   74FC         MOV     A,#-0x4
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    429            afIncomingMSGPacket_t *MSGpkt;
    430            #ifndef DEV_COOR//存放加入网络的数据
    431               uint8 buffer[4];
    432            #endif
    433            (void)task_id;  // Intentionally unreferenced parameter
    434          
    435            if ( events & SYS_EVENT_MSG )
   \   00000E   5480         ANL     A,#0x80
   \   000010   7003         JNZ     $+5
   \   000012   02....       LJMP    ??SampleApp_ProcessEvent_0 & 0xFFFF
    436            {
    437              MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SampleApp_TaskID );
   \   000015                ; Setup parameters for call to function osal_msg_receive
   \   000015   02....       LJMP    ??SampleApp_ProcessEvent_1 & 0xFFFF
    438              while ( MSGpkt )
    439              {
    440                switch ( MSGpkt->hdr.event )
    441                {
    442          #ifdef DEV_COOR
    443                  case CMD_SERIAL_MSG://串口收到数据后由MT_UART层传递过来的数据，用网蜂方法接收，编译时不定义MT相关内容， /***这个函数是来自电脑的串口数据处理函数***/
    444                     SampleApp_SerialCMD((mtOSALSerialData_t *)MSGpkt);//串口收到信息后，事件号 CMD_SERIAL_MSG 就会被登记，便进入 CMD_SERIAL_MSG: 执行 SampleApp_SerialCMD((mtOSALSerialData_t *)MSGpkt);         
    445                     break;
    446          #endif
    447                      
    448                  // Received when a key is pressed
    449                  case KEY_CHANGE:
    450                    //按键发送改变
    451                    SampleApp_HandleKeys( ((keyChange_t *)MSGpkt)->state, ((keyChange_t *)MSGpkt)->keys );
    452                    break;
    453          
    454                  // Received when a messages is received (OTA) for this endpoint
    455                  case AF_INCOMING_MSG_CMD:
    456                    SampleApp_MessageMSGCB( MSGpkt );
    457                    break;
    458          
    459                  // Received whenever the device changes state in the network
    460                  case ZDO_STATE_CHANGE://网络出现状态机发生变化
    461                    SampleApp_NwkState = (devStates_t)(MSGpkt->hdr.status);
   \                     ??SampleApp_ProcessEvent_2:
   \   000018   A3           INC     DPTR
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   90....       MOV     DPTR,#SampleApp_NwkState
   \   00001D   F0           MOVX    @DPTR,A
    462                    if ( //(SampleApp_NwkState == DEV_ZB_COORD)||//协调者不给自己点播
    463                         //(SampleApp_NwkState == DEV_ROUTER)|| //协调者不给路由点播
    464                        (SampleApp_NwkState == DEV_END_DEVICE))
   \   00001E   6406         XRL     A,#0x6
   \   000020   707F         JNZ     ??SampleApp_ProcessEvent_3
    465                    {
    466           #ifndef DEV_COOR//终端向协调器发送加入网络的数据包 数据包格式为    m 房间号（ROOM_NUM） 设备号（DEV_NUM） g
    467                      buffer[0] = 'm';
   \   000022   85..82       MOV     DPL,?XSP + 0
   \   000025   85..83       MOV     DPH,?XSP + 1
   \   000028   746D         MOV     A,#0x6d
   \   00002A   F0           MOVX    @DPTR,A
    468                      buffer[1] = ROOM_NUM;//          
   \   00002B   7401         MOV     A,#0x1
   \   00002D   12....       LCALL   ?XSTACK_DISP0_8
   \   000030   E4           CLR     A
   \   000031   F0           MOVX    @DPTR,A
    469                      buffer[2] = DEV_NUM;
   \   000032   7402         MOV     A,#0x2
   \   000034   12....       LCALL   ?XSTACK_DISP0_8
   \   000037   7401         MOV     A,#0x1
   \   000039   F0           MOVX    @DPTR,A
    470                      buffer[3] = 'g';
   \   00003A   7403         MOV     A,#0x3
   \   00003C   12....       LCALL   ?XSTACK_DISP0_8
   \   00003F   7467         MOV     A,#0x67
   \   000041   F0           MOVX    @DPTR,A
    471                      SampleApp_Point_to_Point_DstAddr.addr.shortAddr = 0x0000;
   \   000042   90....       MOV     DPTR,#SampleApp_Point_to_Point_DstAddr
   \   000045   E4           CLR     A
   \   000046   F0           MOVX    @DPTR,A
   \   000047   A3           INC     DPTR
   \   000048   F0           MOVX    @DPTR,A
    472                      if ( AF_DataRequest( &SampleApp_Point_to_Point_DstAddr,
    473                                 &SampleApp_epDesc,
    474                                 SAMPLEAPP_ADDNET_CLUSTERID,
    475                                 4,
    476                                 buffer,
    477                                 &SampleApp_TransID,
    478                                 AF_DISCV_ROUTE | AF_ACK_REQUEST,
    479                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
   \   000049                ; Setup parameters for call to function AF_DataRequest
   \   000049   75..1E       MOV     ?V0 + 2,#0x1e
   \   00004C   78..         MOV     R0,#?V0 + 2
   \   00004E   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000051   75....       MOV     ?V0 + 2,#SampleApp_TransID & 0xff
   \   000054   75....       MOV     ?V0 + 3,#(SampleApp_TransID >> 8) & 0xff
   \   000057   78..         MOV     R0,#?V0 + 2
   \   000059   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00005C   7403         MOV     A,#0x3
   \   00005E   12....       LCALL   ?XSTACK_DISP0_8
   \   000061   8582..       MOV     ?V0 + 2,DPL
   \   000064   8583..       MOV     ?V0 + 3,DPH
   \   000067   78..         MOV     R0,#?V0 + 2
   \   000069   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00006C   75..04       MOV     ?V0 + 2,#0x4
   \   00006F   75..00       MOV     ?V0 + 3,#0x0
   \   000072   78..         MOV     R0,#?V0 + 2
   \   000074   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000077   75..05       MOV     ?V0 + 2,#0x5
   \   00007A   78..         MOV     R0,#?V0 + 2
   \   00007C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00007F   7930         MOV     R1,#0x30
   \   000081   7C..         MOV     R4,#SampleApp_epDesc & 0xff
   \   000083   7D..         MOV     R5,#(SampleApp_epDesc >> 8) & 0xff
   \   000085   7A..         MOV     R2,#SampleApp_Point_to_Point_DstAddr & 0xff
   \   000087   7B..         MOV     R3,#(SampleApp_Point_to_Point_DstAddr >> 8) & 0xff
   \   000089   12....       LCALL   ??AF_DataRequest?relay
   \   00008C   7409         MOV     A,#0x9
   \   00008E   12....       LCALL   ?DEALLOC_XSTACK8
   \   000091   E9           MOV     A,R1
   \   000092   700D         JNZ     ??SampleApp_ProcessEvent_3
    480                             {
    481                                #ifdef DEBUG_STAGE
    482                                         HalUARTWrite(0,"Init EndPoint\n\r",sizeof("Init EndPoint\n\r"));
   \   000094                ; Setup parameters for call to function HalUARTWrite
   \   000094   7C10         MOV     R4,#0x10
   \   000096   7D00         MOV     R5,#0x0
   \   000098   7A..         MOV     R2,#`?<Constant "Init EndPoint\\n\\r">` & 0xff
   \   00009A   7B..         MOV     R3,#(`?<Constant "Init EndPoint\\n\\r">` >> 8) & 0xff
   \   00009C   7900         MOV     R1,#0x0
   \   00009E   12....       LCALL   ??HalUARTWrite?relay
    483                                       //HalLedSet(LED1,LED_ON);
    484                                #endif 
    485                             }
    486                          else
    487                            {
    488                            // Error occurred in request to send.
    489                             }
    490                      /*****原函数被注释
    491                      // Start sending the periodic message in a regular interval.
    492                      osal_start_timerEx( SampleApp_TaskID,
    493                                        SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
    494                                        SAMPLEAPP_SEND_PERIODIC_MSG_TIMEOUT );
    495                      */
    496          #endif
    497                    }
    498                    else
    499                    {
    500                      // Device is no longer in the network
    501                    }
    502                    break;
    503          
    504                  default:
    505                    break;
    506                }
    507          
    508                // Release the memory
    509                osal_msg_deallocate( (uint8 *)MSGpkt );
   \                     ??SampleApp_ProcessEvent_3:
   \   0000A1                ; Setup parameters for call to function osal_msg_deallocate
   \   0000A1   AA..         MOV     R2,?V0 + 0
   \   0000A3   AB..         MOV     R3,?V0 + 1
   \   0000A5   12....       LCALL   ??osal_msg_deallocate?relay
    510          
    511                // Next - if one is available
    512                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SampleApp_TaskID );
   \   0000A8                ; Setup parameters for call to function osal_msg_receive
   \                     ??SampleApp_ProcessEvent_1:
   \   0000A8   90....       MOV     DPTR,#SampleApp_TaskID
   \   0000AB   E0           MOVX    A,@DPTR
   \   0000AC   F9           MOV     R1,A
   \   0000AD   12....       LCALL   ??osal_msg_receive?relay
   \   0000B0   8A..         MOV     ?V0 + 0,R2
   \   0000B2   8B..         MOV     ?V0 + 1,R3
   \   0000B4   E5..         MOV     A,?V0 + 0
   \   0000B6   45..         ORL     A,?V0 + 1
   \   0000B8   601D         JZ      ??SampleApp_ProcessEvent_4
   \   0000BA   85..82       MOV     DPL,?V0 + 0
   \   0000BD   85..83       MOV     DPH,?V0 + 1
   \   0000C0   E0           MOVX    A,@DPTR
   \   0000C1   24E6         ADD     A,#-0x1a
   \   0000C3   6009         JZ      ??SampleApp_ProcessEvent_5
   \   0000C5   2449         ADD     A,#0x49
   \   0000C7   7003         JNZ     $+5
   \   0000C9   02....       LJMP    ??SampleApp_ProcessEvent_2 & 0xFFFF
   \   0000CC   80D3         SJMP    ??SampleApp_ProcessEvent_3
   \                     ??SampleApp_ProcessEvent_5:
   \   0000CE                ; Setup parameters for call to function SampleApp_MessageMSGCB
   \   0000CE   AA..         MOV     R2,?V0 + 0
   \   0000D0   AB..         MOV     R3,?V0 + 1
   \   0000D2   12....       LCALL   ??SampleApp_MessageMSGCB?relay
   \   0000D5   80CA         SJMP    ??SampleApp_ProcessEvent_3
    513              }
    514          
    515              // return unprocessed events
    516              return (events ^ SYS_EVENT_MSG);
   \                     ??SampleApp_ProcessEvent_4:
   \   0000D7   EE           MOV     A,R6
   \   0000D8   FA           MOV     R2,A
   \   0000D9   EF           MOV     A,R7
   \   0000DA   6480         XRL     A,#0x80
   \                     ??SampleApp_ProcessEvent_6:
   \   0000DC   FB           MOV     R3,A
   \   0000DD   8027         SJMP    ??SampleApp_ProcessEvent_7
    517            }
    518          
    519            // Send a message out - This event is generated by a timer
    520            //  (setup in SampleApp_Init()).
    521            if ( events & SAMPLEAPP_SEND_PERIODIC_MSG_EVT )//加入网络后一直在执行这个状态
   \                     ??SampleApp_ProcessEvent_0:
   \   0000DF   EE           MOV     A,R6
   \   0000E0   A2E0         MOV     C,0xE0 /* A   */.0
   \   0000E2   501E         JNC     ??SampleApp_ProcessEvent_8
    522            {
    523              // Send the periodic message
    524              SampleApp_SendPeriodicMessage();
    525              /**********修改使用的函数********/
    526              //SampleApp_PointToPointMessage();
    527              /******/
    528              // Setup to send message again in normal period (+ a little jitter)
    529              osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
    530                  (SAMPLEAPP_SEND_PERIODIC_MSG_TIMEOUT + (osal_rand() & 0x00FF)) );
   \   0000E4                ; Setup parameters for call to function osal_rand
   \   0000E4   12....       LCALL   ??osal_rand?relay
   \   0000E7                ; Setup parameters for call to function osal_start_timerEx
   \   0000E7   EA           MOV     A,R2
   \   0000E8   2488         ADD     A,#-0x78
   \   0000EA   FC           MOV     R4,A
   \   0000EB   E4           CLR     A
   \   0000EC   3413         ADDC    A,#0x13
   \   0000EE   FD           MOV     R5,A
   \   0000EF   7A01         MOV     R2,#0x1
   \   0000F1   7B00         MOV     R3,#0x0
   \   0000F3   90....       MOV     DPTR,#SampleApp_TaskID
   \   0000F6   E0           MOVX    A,@DPTR
   \   0000F7   F9           MOV     R1,A
   \   0000F8   12....       LCALL   ??osal_start_timerEx?relay
    531          
    532              // return unprocessed events
    533              return (events ^ SAMPLEAPP_SEND_PERIODIC_MSG_EVT);
   \   0000FB   EE           MOV     A,R6
   \   0000FC   6401         XRL     A,#0x1
   \   0000FE   FA           MOV     R2,A
   \   0000FF   EF           MOV     A,R7
   \   000100   80DA         SJMP    ??SampleApp_ProcessEvent_6
    534            }
    535          
    536            // Discard unknown events
    537            return 0;
   \                     ??SampleApp_ProcessEvent_8:
   \   000102   7A00         MOV     R2,#0x0
   \   000104   7B00         MOV     R3,#0x0
   \                     ??SampleApp_ProcessEvent_7:
   \   000106   7404         MOV     A,#0x4
   \   000108                REQUIRE ?Subroutine0
   \   000108                ; // Fall through to label ?Subroutine0
    538          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   12....       LCALL   ?DEALLOC_XSTACK8
   \   000003   7F04         MOV     R7,#0x4
   \   000005   02....       LJMP    ?BANKED_LEAVE_XDATA
    539          
    540          /*********************************************************************
    541           * Event Generation Functions
    542           */
    543          /*********************************************************************
    544           * @fn      SampleApp_HandleKeys
    545           *
    546           * @brief   Handles all key events for this device.所有按键处理函数
    547           *
    548           * @param   shift - true if in shift/alt.
    549           * @param   keys - bit field for key events. Valid entries:
    550           *                 HAL_KEY_SW_2
    551           *                 HAL_KEY_SW_1
    552           *
    553           * @return  none
    554           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    555          void SampleApp_HandleKeys( uint8 shift, uint8 keys )
   \                     SampleApp_HandleKeys:
    556          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    557            (void)shift;  // Intentionally unreferenced parameter
    558            
    559            if ( keys & HAL_KEY_SW_1 )
    560            {
    561              /* This key sends the Flash Command is sent to Group 1.
    562               * This device will not receive the Flash Command from this
    563               * device (even if it belongs to group 1).
    564               */
    565              /*
    566               #ifdef DEV_DOORBELL
    567                 DoorBellPressed =1;
    568               #endif
    569              */
    570              //HalLedBlink(HAL_LED_1,2,50,500);//
    571             // SampleApp_SendFlashMessage( SAMPLEAPP_FLASH_DURATION );
    572            }
    573          
    574            if ( keys & HAL_KEY_SW_2 )
    575            {
    576              /* The Flashr Command is sent to Group 1.
    577               * This key toggles this device in and out of group 1.
    578               * If this device doesn't belong to group 1, this application
    579               * will not receive the Flash command sent to group 1.
    580               */
    581              /*
    582              aps_Group_t *grp;
    583              grp = aps_FindGroup( SAMPLEAPP_ENDPOINT, SAMPLEAPP_FLASH_GROUP );
    584              if ( grp )
    585              {
    586                // Remove from the group
    587                aps_RemoveGroup( SAMPLEAPP_ENDPOINT, SAMPLEAPP_FLASH_GROUP );
    588              }
    589              else
    590              {
    591                // Add to the flash group
    592                aps_AddGroup( SAMPLEAPP_ENDPOINT, &SampleApp_Group );
    593              }
    594            }
    595              */
    596            }
    597          }
   \   000000   02....       LJMP    ?BRET
    598          
    599          /*********************************************************************
    600           * LOCAL FUNCTIONS
    601           */
    602          
    603          /*********************************************************************
    604           * @fn      SampleApp_MessageMSGCB接收处理函数。
    605           *
    606           * @brief   Data message processor callback.  This function processes
    607           *          any incoming data - probably from other devices.  So, based
    608           *          on cluster ID, perform the intended action.
    609           *
    610           * @param   none
    611           *
    612           * @return  none
    613           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    614          void SampleApp_MessageMSGCB( afIncomingMSGPacket_t *pkt )//接受数据处理函数
   \                     SampleApp_MessageMSGCB:
    615          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 7
   \   000005   74F9         MOV     A,#-0x7
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 0,R2
   \   00000C   8B..         MOV     ?V0 + 1,R3
    616           // uint16 flashTime;
    617            uint8 *str = NULL; 
    618            #ifndef DEV_COOR
    619               uint8 reply_buf[CMD_LEN]; //reply_buf[7]
    620               #ifdef DEBUG_STAGE
    621                 int i;
    622               #endif
    623            #endif
    624            #ifdef DEV_COOR
    625                uint8 buffer[4];//用于处理应答
    626                uint16 shortaddr;//用来存放短地址
    627            #endif
    628            str = pkt->cmd.Data;
   \   00000E   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_4:
   \   000011   F9           MOV     R1,A
   \   000012   E8           MOV     A,R0
   \   000013   FE           MOV     R6,A
   \   000014   E9           MOV     A,R1
   \   000015   FF           MOV     R7,A
    629            switch ( pkt->clusterId )
   \   000016   8A82         MOV     DPL,R2
   \   000018   8B83         MOV     DPH,R3
   \   00001A   A3           INC     DPTR
   \   00001B   A3           INC     DPTR
   \   00001C   A3           INC     DPTR
   \   00001D   A3           INC     DPTR
   \   00001E   E0           MOVX    A,@DPTR
   \   00001F   F5..         MOV     ?V0 + 2,A
   \   000021   A3           INC     DPTR
   \   000022   E0           MOVX    A,@DPTR
   \   000023   F5..         MOV     ?V0 + 3,A
   \   000025   78..         MOV     R0,#?V0 + 2
   \   000027   12....       LCALL   ?US_SWITCH_DENSE
   \                     `?<Jumptable for SampleApp_MessageMSGCB>_0`:
   \   00002A   0300         DW        3
   \   00002C   02           DB        2
   \   00002D   ....         DW        ??SampleApp_MessageMSGCB_0
   \   00002F   ....         DW        ??SampleApp_MessageMSGCB_1
   \   000031   ....         DW        ??SampleApp_MessageMSGCB_0
   \   000033   ....         DW        ??SampleApp_MessageMSGCB_2
    630            {
    631              /***自己添加的条件分支***/
    632              case SAMPLEAPP_POINT_TO_POINT_CLUSTERID:
    633                #ifndef DEV_COOR                         
    634                  // HalLedSet(LED2,LED_ON);
    635                    #ifdef DEBUG_STAGE
    636                       for(i=0;i<CMD_LEN;i++)
   \                     ??SampleApp_MessageMSGCB_1:
   \   000035   75..00       MOV     ?V0 + 2,#0x0
   \   000038   75..00       MOV     ?V0 + 3,#0x0
    637                       HalUARTWrite(0,str+i,1 ); 
   \                     ??SampleApp_MessageMSGCB_3:
   \   00003B                ; Setup parameters for call to function HalUARTWrite
   \   00003B   7C01         MOV     R4,#0x1
   \   00003D   7D00         MOV     R5,#0x0
   \   00003F   EE           MOV     A,R6
   \   000040   25..         ADD     A,?V0 + 2
   \   000042   FA           MOV     R2,A
   \   000043   EF           MOV     A,R7
   \   000044   35..         ADDC    A,?V0 + 3
   \   000046   FB           MOV     R3,A
   \   000047   7900         MOV     R1,#0x0
   \   000049   12....       LCALL   ??HalUARTWrite?relay
   \   00004C   E5..         MOV     A,?V0 + 2
   \   00004E   2401         ADD     A,#0x1
   \   000050   F5..         MOV     ?V0 + 2,A
   \   000052   E5..         MOV     A,?V0 + 3
   \   000054   3400         ADDC    A,#0x0
   \   000056   F5..         MOV     ?V0 + 3,A
   \   000058   C3           CLR     C
   \   000059   E5..         MOV     A,?V0 + 2
   \   00005B   9407         SUBB    A,#0x7
   \   00005D   E5..         MOV     A,?V0 + 3
   \   00005F   9400         SUBB    A,#0x0
   \   000061   A2D2         MOV     C,0xD0 /* PSW */.2
   \   000063   65D0         XRL     A,PSW
   \   000065   33           RLC     A
   \   000066   40D3         JC      ??SampleApp_MessageMSGCB_3
    638                    #endif 
    639                      if(str[CmdFlag] == FRAME_FLAG && pkt->srcAddr.addr.shortAddr == 0x0000)   //确认帧头和源地址 
   \   000068   8E82         MOV     DPL,R6
   \   00006A   8F83         MOV     DPH,R7
   \   00006C   E0           MOVX    A,@DPTR
   \   00006D   647F         XRL     A,#0x7f
   \   00006F   6003         JZ      $+5
   \   000071   02....       LJMP    ??SampleApp_MessageMSGCB_0 & 0xFFFF
   \   000074   85..82       MOV     DPL,?V0 + 0
   \   000077   85..83       MOV     DPH,?V0 + 1
   \   00007A   A3           INC     DPTR
   \   00007B   A3           INC     DPTR
   \   00007C   A3           INC     DPTR
   \   00007D   A3           INC     DPTR
   \   00007E   A3           INC     DPTR
   \   00007F   A3           INC     DPTR
   \   000080   E0           MOVX    A,@DPTR
   \   000081   F8           MOV     R0,A
   \   000082   A3           INC     DPTR
   \   000083   E0           MOVX    A,@DPTR
   \   000084   F9           MOV     R1,A
   \   000085   E8           MOV     A,R0
   \   000086   49           ORL     A,R1
   \   000087   6003         JZ      $+5
   \   000089   02....       LJMP    ??SampleApp_MessageMSGCB_0 & 0xFFFF
    640                      {
    641                        reply_buf[CmdFlag] = FRAME_FLAG;//框架判断
   \   00008C   85..82       MOV     DPL,?XSP + 0
   \   00008F   85..83       MOV     DPH,?XSP + 1
   \   000092   747F         MOV     A,#0x7f
   \   000094   12....       LCALL   ?Subroutine3 & 0xFFFF
    642                        switch(str[CmdDevType])
   \                     ??CrossCallReturnLabel_6:
   \   000097   6003         JZ      $+5
   \   000099   02....       LJMP    ??SampleApp_MessageMSGCB_4 & 0xFFFF
    643                        {
    644                          /************************灯******************/
    645                          #ifdef DEV_LIGHT
    646                            case CMD_DEV_LED:
    647                              if(str[CmdType] == CMD_TYPE_CONTROLREQUEST)//是否为控制
   \   00009C   8E82         MOV     DPL,R6
   \   00009E   8F83         MOV     DPH,R7
   \   0000A0   A3           INC     DPTR
   \   0000A1   E0           MOVX    A,@DPTR
   \   0000A2   6403         XRL     A,#0x3
   \   0000A4   7041         JNZ     ??SampleApp_MessageMSGCB_5
    648                               {
    649                                    switch(str[CmdCtrlType])//命令控制的类型
   \   0000A6   8E82         MOV     DPL,R6
   \   0000A8   8F83         MOV     DPH,R7
   \   0000AA   A3           INC     DPTR
   \   0000AB   A3           INC     DPTR
   \   0000AC   E0           MOVX    A,@DPTR
   \   0000AD   6005         JZ      ??SampleApp_MessageMSGCB_6
   \   0000AF   14           DEC     A
   \   0000B0   6016         JZ      ??SampleApp_MessageMSGCB_7
   \   0000B2   8023         SJMP    ??SampleApp_MessageMSGCB_8
    650                                    {
    651                                          case CMD_CONTROL_OPEN:
    652                                                        {
    653                                                            reply_buf[CmdCtrlValue] = 1; 
   \                     ??SampleApp_MessageMSGCB_6:
   \   0000B4   7403         MOV     A,#0x3
   \   0000B6   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B9   7401         MOV     A,#0x1
   \   0000BB   12....       LCALL   ?Subroutine1 & 0xFFFF
    654                                                            switch(str[CmdDevId])
   \                     ??CrossCallReturnLabel_0:
   \   0000BE   7004         JNZ     ??SampleApp_MessageMSGCB_9
    655                                                            {
    656                                                               case 0:
    657                                                                  DEV_LIGHT1_OPEN()
   \   0000C0   D284         SETB    0x80.4
    658                                                                  break;
   \   0000C2   801B         SJMP    ??SampleApp_MessageMSGCB_10
    659                                                               default:
    660                                                                      reply_buf[CmdCtrlValue] = ERROR_FLAG;
   \                     ??SampleApp_MessageMSGCB_9:
   \   0000C4   7403         MOV     A,#0x3
   \   0000C6   8011         SJMP    ??SampleApp_MessageMSGCB_11
    661                                                            }
    662                                                        }
    663                                         break;
    664                                         case CMD_CONTROL_CLOSE:
    665                                                      {
    666                                                         reply_buf[CmdCtrlValue] = 0; 
   \                     ??SampleApp_MessageMSGCB_7:
   \   0000C8   7403         MOV     A,#0x3
   \   0000CA   12....       LCALL   ?XSTACK_DISP0_8
   \   0000CD   E4           CLR     A
   \   0000CE   12....       LCALL   ?Subroutine1 & 0xFFFF
    667                                                         switch(str[CmdDevId])
   \                     ??CrossCallReturnLabel_1:
   \   0000D1   70F1         JNZ     ??SampleApp_MessageMSGCB_9
    668                                                            {
    669                                                               case 0:
    670                                                                  DEV_LIGHT1_CLOSE()
   \   0000D3   C284         CLR     0x80.4
    671                                                                  break;
   \   0000D5   8008         SJMP    ??SampleApp_MessageMSGCB_10
    672                                                               default:
    673                                                                      reply_buf[CmdCtrlValue] = ERROR_FLAG;
    674                                                            }
    675                                                      }
    676                                         break;
    677                                         default:
    678                                                      reply_buf[CmdCtrlType] = ERROR_FLAG;   
   \                     ??SampleApp_MessageMSGCB_8:
   \   0000D7   7402         MOV     A,#0x2
   \                     ??SampleApp_MessageMSGCB_11:
   \   0000D9   12....       LCALL   ?XSTACK_DISP0_8
   \   0000DC   746F         MOV     A,#0x6f
   \   0000DE   F0           MOVX    @DPTR,A
    679                                    }
    680                                    reply_buf[CmdType] = CMD_TYPE_CONTROLRESPONSE; 
   \                     ??SampleApp_MessageMSGCB_10:
   \   0000DF   7401         MOV     A,#0x1
   \   0000E1   12....       LCALL   ?XSTACK_DISP0_8
   \   0000E4   7404         MOV     A,#0x4
   \   0000E6   F0           MOVX    @DPTR,A
    681                               }                  
    682                              else if(str[CmdType] == CMD_TYPE_CONTROLREQUEST && str[CmdCtrlType] == CMD_CONTROL_READ)//查询
    683                              {
    684                                switch(str[CmdDevId])
    685                                {
    686                                  case 0:
    687                                      if(DEV_LIGHT1_BIT)
    688                                         reply_buf[CmdCtrlValue] = 1;
    689                                      else
    690                                         reply_buf[CmdCtrlValue] = 0;
    691                                  break;
    692                                  default:
    693                                       reply_buf[CmdCtrlValue] = ERROR_FLAG;  
    694                                }
    695                                reply_buf[CmdType] = CMD_TYPE_QUERYRESPONSE; 
    696                              }
    697                              reply_buf[CmdDevType] = CMD_DEV_LED;
   \                     ??SampleApp_MessageMSGCB_5:
   \   0000E7   7405         MOV     A,#0x5
   \   0000E9   12....       LCALL   ?XSTACK_DISP0_8
   \   0000EC   E4           CLR     A
   \   0000ED   F0           MOVX    @DPTR,A
    698                              reply_buf[CmdCtrlType] = str[CmdCtrlType];
   \   0000EE   8E82         MOV     DPL,R6
   \   0000F0   8F83         MOV     DPH,R7
   \   0000F2   A3           INC     DPTR
   \   0000F3   A3           INC     DPTR
   \   0000F4   E0           MOVX    A,@DPTR
   \   0000F5   C0E0         PUSH    A
   \   0000F7   7402         MOV     A,#0x2
   \   0000F9   12....       LCALL   ?XSTACK_DISP0_8
   \   0000FC   D0E0         POP     A
   \   0000FE   12....       LCALL   ?Subroutine1 & 0xFFFF
    699                              reply_buf[CmdDevId] = str[CmdDevId];
   \                     ??CrossCallReturnLabel_2:
   \   000101   C0E0         PUSH    A
   \   000103   7406         MOV     A,#0x6
   \   000105   12....       LCALL   ?XSTACK_DISP0_8
   \   000108   D0E0         POP     A
   \   00010A   F0           MOVX    @DPTR,A
    700                              reply_buf[CmdRoomId] = ROOM_NUM;
   \   00010B   7404         MOV     A,#0x4
   \   00010D   12....       LCALL   ?XSTACK_DISP0_8
   \   000110   E4           CLR     A
   \   000111   F0           MOVX    @DPTR,A
    701                              SampleApp_Point_to_Point_DstAddr.addr.shortAddr = 0x0000;
   \   000112   90....       MOV     DPTR,#SampleApp_Point_to_Point_DstAddr
   \                     ??SampleApp_MessageMSGCB_12:
   \   000115   F0           MOVX    @DPTR,A
   \   000116   A3           INC     DPTR
   \   000117   F0           MOVX    @DPTR,A
    702                              if ( AF_DataRequest( &SampleApp_Point_to_Point_DstAddr, &SampleApp_epDesc,
    703                                     SAMPLEAPP_POINT_TO_POINT_CLUSTERID,
    704                                     CMD_LEN,
    705                                     reply_buf,
    706                                     &SampleApp_TransID,
    707                                     AF_DISCV_ROUTE | AF_ACK_REQUEST,
    708                                     AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
   \   000118                ; Setup parameters for call to function AF_DataRequest
   \   000118   75..1E       MOV     ?V0 + 0,#0x1e
   \   00011B   78..         MOV     R0,#?V0 + 0
   \   00011D   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000120   75....       MOV     ?V0 + 0,#SampleApp_TransID & 0xff
   \   000123   75....       MOV     ?V0 + 1,#(SampleApp_TransID >> 8) & 0xff
   \   000126   78..         MOV     R0,#?V0 + 0
   \   000128   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00012B   7403         MOV     A,#0x3
   \   00012D   12....       LCALL   ?XSTACK_DISP0_8
   \   000130   8582..       MOV     ?V0 + 0,DPL
   \   000133   8583..       MOV     ?V0 + 1,DPH
   \   000136   78..         MOV     R0,#?V0 + 0
   \   000138   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00013B   75..07       MOV     ?V0 + 0,#0x7
   \   00013E   75..00       MOV     ?V0 + 1,#0x0
   \   000141   78..         MOV     R0,#?V0 + 0
   \   000143   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000146   75..03       MOV     ?V0 + 0,#0x3
   \   000149   78..         MOV     R0,#?V0 + 0
   \   00014B   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00014E   7930         MOV     R1,#0x30
   \   000150   7C..         MOV     R4,#SampleApp_epDesc & 0xff
   \   000152   7D..         MOV     R5,#(SampleApp_epDesc >> 8) & 0xff
   \   000154   7A..         MOV     R2,#SampleApp_Point_to_Point_DstAddr & 0xff
   \   000156   7B..         MOV     R3,#(SampleApp_Point_to_Point_DstAddr >> 8) & 0xff
   \   000158   12....       LCALL   ??AF_DataRequest?relay
   \   00015B   7409         MOV     A,#0x9
   \   00015D   12....       LCALL   ?DEALLOC_XSTACK8
    709                                {
    710                      
    711                                 }
    712                             else
    713                              {
    714                                    // Error occurred in request to send.
    715                               }
    716                            break;
   \   000160   02....       LJMP    ??SampleApp_MessageMSGCB_0 & 0xFFFF
    717                       #endif
    718                        default://没找到设备
    719                          reply_buf[CmdType] = CMD_TYPE_QUERYRESPONSE;
   \                     ??SampleApp_MessageMSGCB_4:
   \   000163   7401         MOV     A,#0x1
   \   000165   12....       LCALL   ?XSTACK_DISP0_8
   \   000168   7402         MOV     A,#0x2
   \   00016A   F0           MOVX    @DPTR,A
    720                          reply_buf[CmdCtrlType] = ERROR_FLAG;
   \   00016B   12....       LCALL   ?XSTACK_DISP0_8
   \   00016E   746F         MOV     A,#0x6f
   \   000170   F0           MOVX    @DPTR,A
    721                          reply_buf[CmdCtrlValue]= ERROR_FLAG;
   \   000171   7403         MOV     A,#0x3
   \   000173   12....       LCALL   ?XSTACK_DISP0_8
   \   000176   746F         MOV     A,#0x6f
   \   000178   F0           MOVX    @DPTR,A
    722                          reply_buf[CmdRoomId] = ROOM_NUM;
   \   000179   7404         MOV     A,#0x4
   \   00017B   12....       LCALL   ?XSTACK_DISP0_8
   \   00017E   E4           CLR     A
   \   00017F   12....       LCALL   ?Subroutine3 & 0xFFFF
    723                          reply_buf[CmdDevType] = str[CmdDevType];
   \                     ??CrossCallReturnLabel_7:
   \   000182   C0E0         PUSH    A
   \   000184   7405         MOV     A,#0x5
   \   000186   12....       LCALL   ?XSTACK_DISP0_8
   \   000189   D0E0         POP     A
   \   00018B   12....       LCALL   ?Subroutine1 & 0xFFFF
    724                          reply_buf[CmdDevId] = str[CmdDevId];
   \                     ??CrossCallReturnLabel_3:
   \   00018E   C0E0         PUSH    A
   \   000190   7406         MOV     A,#0x6
   \   000192   12....       LCALL   ?XSTACK_DISP0_8
   \   000195   D0E0         POP     A
   \   000197   F0           MOVX    @DPTR,A
    725                          SampleApp_Point_to_Point_DstAddr.addr.shortAddr = 0x0000;
   \   000198   90....       MOV     DPTR,#SampleApp_Point_to_Point_DstAddr
   \   00019B   E4           CLR     A
   \   00019C   02....       LJMP    ??SampleApp_MessageMSGCB_12 & 0xFFFF
    726                              if ( AF_DataRequest( &SampleApp_Point_to_Point_DstAddr, &SampleApp_epDesc,
    727                                     SAMPLEAPP_POINT_TO_POINT_CLUSTERID,
    728                                     CMD_LEN,
    729                                     reply_buf,
    730                                     &SampleApp_TransID,
    731                                     AF_DISCV_ROUTE | AF_ACK_REQUEST,
    732                                     AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    733                                {
    734                      
    735                                 }
    736                             else
    737                              {
    738                                    // Error occurred in request to send.
    739                               }
    740                            break;
    741                        }         
    742                      }
    743                #else//协调器将由终端返回的回应信息包发送给上位机
    744                if(str[CmdType] == CMD_TYPE_QUERYRESPONSE || str[CmdType] == CMD_TYPE_CONTROLRESPONSE)
    745                {
    746                  HalUARTWrite(0,str,CMD_LEN);
    747                }      
    748                #endif
    749              break;
    750              /*************************/
    751              case SAMPLEAPP_ADDNET_CLUSTERID://入网处理
    752                #ifdef DEV_COOR
    753                    if(pkt->cmd.Data[0]=='m' && pkt->cmd.Data[3]=='g' && pkt->srcAddr.addr.shortAddr != 0)
    754                    {
    755                      HalLedSet(LED1,LED_ON);//协调者led1 亮
    756                      shortaddr = pkt->srcAddr.addr.shortAddr;//把收到的终端的地址保存
    757                      Routing_Table[pkt->cmd.Data[1]][pkt->cmd.Data[2]] = shortaddr;  //对应的房间设备的路由表建立                    
    758                      #ifdef DEBUG_STAGE 
    759                               HalUARTWrite(0,&asc_16[Routing_Table[pkt->cmd.Data[1]][pkt->cmd.Data[2]]/4096],1);
    760                               HalUARTWrite(0,&asc_16[Routing_Table[pkt->cmd.Data[1]][pkt->cmd.Data[2]]%4096/256],1);
    761                               HalUARTWrite(0,&asc_16[Routing_Table[pkt->cmd.Data[1]][pkt->cmd.Data[2]]%256/16],1);
    762                               HalUARTWrite(0,&asc_16[Routing_Table[pkt->cmd.Data[1]][pkt->cmd.Data[2]]%16],1);
    763                      #endif           
    764                       buffer[0] = 'r';//进行回复          
    765                       buffer[1] = 0;
    766                       buffer[2] = 0;
    767                       buffer[3] = 'a';
    768                       SampleApp_Point_to_Point_DstAddr.addr.shortAddr = shortaddr;//并把应答信息发送给终端 入网成功
    769                       if ( AF_DataRequest( &SampleApp_Point_to_Point_DstAddr, &SampleApp_epDesc,
    770                                     SAMPLEAPP_ADDNET_CLUSTERID,
    771                                     4,
    772                                     buffer,
    773                                     &SampleApp_TransID,
    774                                     AF_DISCV_ROUTE | AF_ACK_REQUEST,
    775                                     AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    776                      {
    777                       //  HalUARTWrite(0,"get searchmsg\n\r",sizeof("get searchmsg\n\r"));      
    778                       //  HalUARTWrite(0,"bind one end",12);
    779                         HalLedSet(LED1,LED_OFF);//协调者led1灯灭
    780                      }
    781                      else
    782                      {
    783                        // Error occurred in request to send.
    784                      }
    785                   }
    786              #else        //终端处理入网应答
    787              
    788               if((pkt->cmd.Data[0]=='r' && pkt->cmd.Data[3]=='a') && pkt->srcAddr.addr.shortAddr == 0x0000)
   \                     ??SampleApp_MessageMSGCB_2:
   \   00019F   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_5:
   \   0001A2   F583         MOV     DPH,A
   \   0001A4   8882         MOV     DPL,R0
   \   0001A6   E0           MOVX    A,@DPTR
   \   0001A7   6472         XRL     A,#0x72
   \   0001A9   7038         JNZ     ??SampleApp_MessageMSGCB_0
   \   0001AB   12....       LCALL   ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_10:
   \   0001AE   A3           INC     DPTR
   \   0001AF   E0           MOVX    A,@DPTR
   \   0001B0   F583         MOV     DPH,A
   \   0001B2   8882         MOV     DPL,R0
   \   0001B4   A3           INC     DPTR
   \   0001B5   A3           INC     DPTR
   \   0001B6   A3           INC     DPTR
   \   0001B7   E0           MOVX    A,@DPTR
   \   0001B8   6461         XRL     A,#0x61
   \   0001BA   7027         JNZ     ??SampleApp_MessageMSGCB_0
   \   0001BC   8A82         MOV     DPL,R2
   \   0001BE   8B83         MOV     DPH,R3
   \   0001C0   A3           INC     DPTR
   \   0001C1   A3           INC     DPTR
   \   0001C2   A3           INC     DPTR
   \   0001C3   A3           INC     DPTR
   \   0001C4   A3           INC     DPTR
   \   0001C5   A3           INC     DPTR
   \   0001C6   E0           MOVX    A,@DPTR
   \   0001C7   F8           MOV     R0,A
   \   0001C8   A3           INC     DPTR
   \   0001C9   E0           MOVX    A,@DPTR
   \   0001CA   F9           MOV     R1,A
   \   0001CB   E8           MOV     A,R0
   \   0001CC   49           ORL     A,R1
   \   0001CD   7014         JNZ     ??SampleApp_MessageMSGCB_0
    789               {
    790                #ifdef DEBUG_STAGE
    791                  HalUARTWrite(0,"bind success",12);
   \   0001CF                ; Setup parameters for call to function HalUARTWrite
   \   0001CF   7C0C         MOV     R4,#0xc
   \   0001D1   7D00         MOV     R5,#0x0
   \   0001D3   7A..         MOV     R2,#`?<Constant "bind success">` & 0xff
   \   0001D5   7B..         MOV     R3,#(`?<Constant "bind success">` >> 8) & 0xff
   \   0001D7   7900         MOV     R1,#0x0
   \   0001D9   12....       LCALL   ??HalUARTWrite?relay
    792                #endif
    793                  HalLedSet(LED3,LED_ON);//终端上亮了led1
   \   0001DC                ; Setup parameters for call to function HalLedSet
   \   0001DC   7A01         MOV     R2,#0x1
   \   0001DE   7904         MOV     R1,#0x4
   \   0001E0   12....       LCALL   ??HalLedSet?relay
    794               }
    795               #endif
    796                break;
    797              case SAMPLEAPP_PERIODIC_CLUSTERID:
    798                break;
    799          
    800              case SAMPLEAPP_FLASH_CLUSTERID:
    801              /*  flashTime = BUILD_UINT16(pkt->cmd.Data[1], pkt->cmd.Data[2] );
    802                HalLedBlink( HAL_LED_4, 4, 50, (flashTime / 4) );*/
    803                break;
    804            }
    805          }
   \                     ??SampleApp_MessageMSGCB_0:
   \   0001E3   7407         MOV     A,#0x7
   \   0001E5   02....       LJMP    ?Subroutine0 & 0xFFFF
   \   0001E8                REQUIRE _A_P0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_8:
   \   000003   E0           MOVX    A,@DPTR
   \   000004   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   12....       LCALL   ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_11:
   \   000003   E0           MOVX    A,@DPTR
   \   000004   F8           MOV     R0,A
   \   000005   A3           INC     DPTR
   \   000006   E0           MOVX    A,@DPTR
   \   000007   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine5:
   \   000000   EA           MOV     A,R2
   \   000001   2422         ADD     A,#0x22
   \   000003   F582         MOV     DPL,A
   \   000005   EB           MOV     A,R3
   \   000006   3400         ADDC    A,#0x0
   \   000008   F583         MOV     DPH,A
   \   00000A   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_9:
   \   000003   A3           INC     DPTR
   \   000004   E0           MOVX    A,@DPTR
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   F0           MOVX    @DPTR,A
   \   000001   8E82         MOV     DPL,R6
   \   000003   8F83         MOV     DPH,R7
   \   000005   A3           INC     DPTR
   \   000006   A3           INC     DPTR
   \   000007   A3           INC     DPTR
   \   000008   A3           INC     DPTR
   \   000009   A3           INC     DPTR
   \   00000A   22           RET
    806          
    807          /*********************************************************************
    808           * @fn      SampleApp_SendPeriodicMessage
    809           *
    810           * @brief   Send the periodic message.
    811           *
    812           * @param   none
    813           *
    814           * @return  none
    815           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    816          void SampleApp_SendPeriodicMessage( void )
   \                     SampleApp_SendPeriodicMessage:
    817          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    818            /*
    819            if ( AF_DataRequest( &SampleApp_Periodic_DstAddr, &SampleApp_epDesc,
    820                                 SAMPLEAPP_PERIODIC_CLUSTERID,
    821                                 1,
    822                                 (uint8*)&SampleAppPeriodicCounter,
    823                                 &SampleApp_TransID,
    824                                 AF_DISCV_ROUTE,
    825                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    826            {
    827            }
    828            else
    829            {
    830              // Error occurred in request to send.
    831            }
    832            */
    833          }
   \   000000   02....       LJMP    ?BRET
    834          
    835          /*********************************************************************
    836           * @fn      SampleApp_SendFlashMessage
    837           *
    838           * @brief   Send the flash message to group 1.
    839           *
    840           * @param   flashTime - in milliseconds
    841           *
    842           * @return  none
    843           */
    844          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    845          void SampleApp_SendFlashMessage( uint16 flashTime )
   \                     SampleApp_SendFlashMessage:
    846          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    847            /*
    848            uint8 buffer[3];
    849            buffer[0] = (uint8)(SampleAppFlashCounter++);
    850            buffer[1] = LO_UINT16( flashTime );
    851            buffer[2] = HI_UINT16( flashTime );
    852          
    853            if ( AF_DataRequest( &SampleApp_Flash_DstAddr, &SampleApp_epDesc,
    854                                 SAMPLEAPP_FLASH_CLUSTERID,
    855                                 3,
    856                                 buffer,
    857                                 &SampleApp_TransID,
    858                                 AF_DISCV_ROUTE,
    859                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    860            {
    861            }
    862            else
    863            {
    864              // Error occurred in request to send.
    865            }
    866            */
    867          }
   \   000000   02....       LJMP    ?BRET

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for asc_16>`:
   \   000000   30           DB 48
   \   000001   31           DB 49
   \   000002   32           DB 50
   \   000003   33           DB 51
   \   000004   34           DB 52
   \   000005   35           DB 53
   \   000006   36           DB 54
   \   000007   37           DB 55
   \   000008   38           DB 56
   \   000009   39           DB 57
   \   00000A   41           DB 65
   \   00000B   42           DB 66
   \   00000C   43           DB 67
   \   00000D   44           DB 68
   \   00000E   45           DB 69
   \   00000F   46           DB 70

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SampleApp_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SampleApp_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SampleApp_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SampleApp_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SampleApp_HandleKeys?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SampleApp_HandleKeys

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SampleApp_MessageMSGCB?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SampleApp_MessageMSGCB

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SampleApp_SendPeriodicMessage?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SampleApp_SendPeriodicMessage

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SampleApp_SendFlashMessage?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SampleApp_SendFlashMessage

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "livingroom\\n">`:
   \   000000   6C697669     DB "livingroom\012"
   \            6E67726F
   \            6F6D0A00

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "Group 1">`:
   \   000000   47726F75     DB "Group 1"
   \            70203100

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "Init EndPoint\\n\\r">`:
   \   000000   496E6974     DB "Init EndPoint\012\015"
   \            20456E64
   \            506F696E
   \            740A0D00

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "bind success">`:
   \   000000   62696E64     DB "bind success"
   \            20737563
   \            63657373
   \            00      
    868          
    869          
    870          /*********************************************************************
    871           * @fn      SampleApp_SerialCMD
    872           *
    873           * @brief   串口给的数据处理
    874           *
    875           *
    876           * @return  none
    877           */
    878          #ifdef DEV_COOR
    879          void SampleApp_SerialCMD(mtOSALSerialData_t *cmdMsg) 
    880          {
    881            uint8 dev_num,len,*str = NULL;//len有用的数据长度
    882            str = (cmdMsg->msg+1);//指向真正的数据
    883            len = *(cmdMsg->msg);//指向数据头 就是有多少数据
    884            /****************以下为串口打印接收到的数据*/
    885            #ifdef DEBUG_STAGE
    886              int i;
    887              for(i = 0; i <= len; i++)
    888              HalUARTWrite(0,str+i,1);
    889              HalUARTWrite(0,"\n",1);
    890            #endif
    891              /******仿照点对点的发送模式***/
    892              /*
    893              afAddrType_t SampleApp_Point_to_Point_DstAddr;
    894              SampleApp_Point_to_Point_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
    895              SampleApp_Point_to_Point_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
    896              ampleApp_Point_to_Point_DstAddr.addr.shortAddr = 0xffff;//数据从终端发给协调者
    897              */
    898              if(str[CmdFlag] == FRAME_FLAG && len == CMD_LEN)//判断框架有没有正确 长度有没有正确
    899              {
    900                for(dev_num = 1; dev_num <= DEV_COUNT; dev_num++)
    901                {
    902                  if(Routing_Table[str[CmdRoomId]][dev_num] == 0)
    903                  {
    904                     str[CmdRoomId] = ERROR_FLAG;
    905                     HalUARTWrite(0,str,CMD_LEN);
    906                     return;
    907                  }
    908                 SampleApp_Point_to_Point_DstAddr.addr.shortAddr = Routing_Table[str[CmdRoomId]][dev_num];
    909                       if ( AF_DataRequest( &SampleApp_Point_to_Point_DstAddr,
    910                                 &SampleApp_epDesc,
    911                                 SAMPLEAPP_POINT_TO_POINT_CLUSTERID,
    912                                 len,//数据长度
    913                                 str,//数据内容
    914                                 &SampleApp_TransID,
    915                                 AF_DISCV_ROUTE,
    916                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    917                          {
    918                            }
    919                       else
    920                       {
    921                          // Error occurred in request to send.
    922                       }
    923               }
    924           }
    925          }
    926          #endif

   Maximum stack usage in bytes:

     Function                      ISTACK PSTACK XSTACK
     --------                      ------ ------ ------
     SampleApp_HandleKeys              0      0      0
     SampleApp_Init                    0      0     14
       -> MT_UartInit                  0      0     22
       -> MT_UartRegisterTaskID        0      0     22
       -> HalUARTWrite                 0      0     22
       -> afRegister                   0      0     22
       -> RegisterForKeys              0      0     22
       -> osal_memcpy                  0      0     28
       -> aps_AddGroup                 0      0     22
     SampleApp_MessageMSGCB            1      0     44
       -> HalUARTWrite                 0      0     38
       -> AF_DataRequest               0      0     56
       -> AF_DataRequest               0      0     56
       -> HalUARTWrite                 0      0     38
       -> HalLedSet                    0      0     38
     SampleApp_ProcessEvent            0      0     25
       -> osal_msg_receive             0      0     32
       -> AF_DataRequest               0      0     50
       -> HalUARTWrite                 0      0     32
       -> osal_msg_deallocate          0      0     32
       -> osal_msg_receive             0      0     32
       -> SampleApp_MessageMSGCB       0      0     32
       -> osal_rand                    0      0     32
       -> osal_start_timerEx           0      0     32
     SampleApp_SendFlashMessage        0      0      0
     SampleApp_SendPeriodicMessage     0      0      0


   Segment part sizes:

     Function/Label                        Bytes
     --------------                        -----
     _A_P0                                    1
     P0SEL                                    1
     P0DIR                                    1
     SampleApp_ClusterList                    4
     SampleApp_SimpleDesc                    12
     SampleApp_epDesc                         6
     SampleApp_TaskID                         1
     SampleApp_NwkState                       1
     asc_16                                  16
     SampleApp_TransID                        1
     SampleApp_Periodic_DstAddr              12
     SampleApp_Flash_DstAddr                 12
     SampleApp_Point_to_Point_DstAddr
                                             12
     SampleApp_Group                         18
     SampleAppPeriodicCounter                 1
     SampleAppFlashCounter                    1
     SampleApp_Init                         198
     SampleApp_ProcessEvent                 264
     ?Subroutine0                             8
     SampleApp_HandleKeys                     3
     SampleApp_MessageMSGCB                 488
     ?Subroutine3                             5
     ?Subroutine2                             8
     ?Subroutine5                            11
     ?Subroutine1                             6
     ?Subroutine4                            11
     SampleApp_SendPeriodicMessage            3
     SampleApp_SendFlashMessage               3
     ?<Initializer for asc_16>               16
     ??SampleApp_Init?relay                   6
     ??SampleApp_ProcessEvent?relay           6
     ??SampleApp_HandleKeys?relay             6
     ??SampleApp_MessageMSGCB?relay           6
     ??SampleApp_SendPeriodicMessage?relay    6
     ??SampleApp_SendFlashMessage?relay       6
     ?<Constant "livingroom\n">              12
     ?<Constant "Group 1">                    8
     ?<Constant "Init EndPoint\n\r">         16
     ?<Constant "bind success">              13

 
 1 008 bytes in segment BANKED_CODE
    36 bytes in segment BANK_RELAYS
     3 bytes in segment SFR_AN
    16 bytes in segment XDATA_I
    16 bytes in segment XDATA_ID
    65 bytes in segment XDATA_ROM_C
    65 bytes in segment XDATA_Z
 
 1 060 bytes of CODE  memory
    65 bytes of CONST memory
     0 bytes of DATA  memory (+ 3 bytes shared)
    81 bytes of XDATA memory

Errors: none
Warnings: none
